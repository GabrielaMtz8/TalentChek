<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="lib/img/logoredondo.png">
    <title>Examen de Conocimiento</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="lib/css/examenCono.css" />
  </head>
  <body>
    <div class="main-layout">
      <header class="main-header">
        <a href="perfilCandidato.html" class="header-left">
          <img src="lib/img/logo.jpg" alt="Logo" />
          <span class="title">TalentCheck</span>
        </a>
        <div class="user-menu">
          <span id="userIcon" class="user-icon">👤</span>
          <div id="dropdownMenu" class="dropdown">
            <a href="#" id="logoutBtn">Cerrar sesión</a>
            <a href="perfil.html">Ver Perfil</a>
          </div>
        </div>
      </header>

      <div class="container">
        <aside class="sidebar">
          <nav class="nav">
            <a href="perfilCandidato.html"
              ><button class="nav-btn"><i class="fas fa-home"></i></button
            ></a>
            <a href="modificar.html"
              ><button class="nav-btn"><i class="fas fa-edit"></i></button
            ></a>
            <a href="proceso.html"
              ><button class="nav-btn">
                <i class="fas fa-spinner fa-spin"></i></button
            ></a>
            <a href="acceso.html"
              ><button class="nav-btn">
                <i class="fas fa-clipboard-list"></i></button
            ></a>
            <a href="accesodos.html"
              ><button class="nav-btn"><i class="fas fa-brain"></i></button
            ></a>
          </nav>
        </aside>

        <main class="exam-content">
          <!-- Video de cámara -->
          <div id="video-container">
            <video id="video" width="100" height="80" autoplay muted></video>
          </div>

          <!-- Paso: Introducción -->
          <section class="intro-section" id="intro">
            <div class="robot-box">
              <img
                src="https://cdn-icons-png.flaticon.com/512/4712/4712107.png"
                class="robot-img"
                alt="Robot"
              />
            </div>
            <h2>Evaluación de Conocimiento</h2>
            <button class="camera-btn" id="camara" onclick="activarCamara()">
              <i class="fas fa-video"></i> Encender cámara
            </button>
            <button class="start-btn" id="startBtn" onclick="startEvaluation()" disabled>
              Iniciar evaluación
            </button>
            <p class="camera-warning">
              * Debes permitir el acceso a la cámara para comenzar el examen.
            </p>
          </section>

          <!-- Paso 1 -->
          <section class="question-section" id="step-1" style="display: none">
            <div class="question">
              <p>
                <strong> 1.	¿Cuál es un sistema de gestión de bases de datos relacional?</strong>
              </p>
              <label
                ><input type="radio" name="q1" value="MongoDB" /> MongoDB</label
              >
              <label
                ><input type="radio" name="q1" value="Redis" /> Redis</label
              >
              <label
                ><input type="radio" name="q1" value="Dart" /> MySQL</label
              >
              <label
                ><input type="radio" name="q1" value="Elasticsearch" /> Elasticsearch</label
              >
            </div>
            <div class="question">
              <p>
                <strong> 2.	¿Qué comando SQL se utiliza para obtener datos de una tabla?</strong>
              </p>
              <label><input type="radio" name="q2" value="UPDATE" /> UPDATE</label>
              <label><input type="radio" name="q2" value="SELECT" /> SELECT</label>
              <label><input type="radio" name="q2" value="INSERT" /> INSERT</label>
              <label><input type="radio" name="q2" value="INSERT" /> INSERT</label>
            </div>
            <button class="next-btn" onclick="nextStep(1)">Siguiente</button>
          </section>

          <!-- Paso 2 -->
          <section class="question-section" id="step-2" style="display: none">
            <div class="question">
              <p><strong> 3.	¿Qué tipo de base de datos es MongoDB?</strong></p>
              <label><input type="radio" name="q3" value="Relacional" /> Relacional</label>
              <label><input type="radio" name="q3" value="NoSQL" /> NoSQL</label>
              <label><input type="radio" name="q3" value="Clásica" /> Clásica</label>
              <label><input type="radio" name="q3" value="Distribuida" /> Distribuida</label>
            </div>
            <div class="question">
              <p><strong> 4.	¿Cuál es la función de un índice en una base de datos?</strong></p>
              <label><input type="radio" name="q4" value="Aumentar el tamaño de la tabla" /> Aumentar el tamaño de la tabla</label>
              <label><input type="radio" name="q4" value="Reducir el tiempo de respuesta de las consultas" /> Reducir el tiempo de respuesta de las consultas</label>
              <label><input type="radio" name="q4" value="Eliminar duplicados" /> Eliminar duplicados</label>
              <label><input type="radio" name="q4" value="Comprimir registros" /> Comprimir registros</label>
            </div>
            <button class="next-btn" onclick="nextStep(2)">Siguiente</button>
          </section>

          <!-- Paso 3 -->
          <section class="question-section" id="step-3" style="display: none">
            <div class="question">
              <p><strong> 5.	¿Qué significa la sigla ACID en bases de datos?</strong></p>
              <label>
                <input type="radio" name="q5" value="Atomicidad, Consistencia, Aislamiento, Durabilidad"/> Atomicidad, Consistencia, Aislamiento, Durabilidad
              </label>
              <label>
                <input type="radio" name="q5"value="Aceleración, Control, Integridad, Datos"/> Aceleración, Control, Integridad, Datos
              </label>
              <label>
                <input type="radio" name="q5" value="Actualización, Compresión, Identificación, Depuración"/> Actualización, Compresión, Identificación, Depuración
              </label>
              <label>
                <input type="radio" name="q5" value="Ninguna de las anteriores" /> Ninguna de las anteriores
              </label>
            </div>
            <div class="question">
              <p><strong> 6.	¿Cuál es una buena práctica para realizar respaldos de base de datos?</strong></p>
              <label>
                <input type="radio" name="q6" value="Hacer copias manuales esporádicas"/> Hacer copias manuales esporádicas
              </label>
              <label>
                <input type="radio" name="q6" value="Usar comandos de eliminación antes de copiar"/> Usar comandos de eliminación antes de copiar
              </label>
              <label>
                <input type="radio" name="q6" value="Automatizar los respaldos diarios"/> Automatizar los respaldos diarios
              </label>
              <label>
                <input type="radio" name="q6" value="Desactivar las restricciones de integridad"/>  Desactivar las restricciones de integridad
              </label>
            </div>
            <button class="next-btn" onclick="nextStep(3)">Siguiente</button>
          </section>

          <!-- Paso 4 -->
          <section class="question-section" id="step-4" style="display: none">
            <div class="question">
              <p><strong> 7.	¿Qué lenguaje se usa para consultar bases de datos SQL?</strong></p>
              <label><input type="radio" name="q7" value="HTML" /> HTML</label>
              <label><input type="radio" name="q7" value="JSON" /> JSON</label>
              <label><input type="radio" name="q7" value="SQL" /> SQL</label>
              <label><input type="radio" name="q7" value="XML" /> XML</label>
            </div>
            <div class="question">
              <p><strong> 8.	¿Qué herramienta permite monitorear bases de datos en tiempo real?</strong></p>
              <label>
                <input type="radio" name="q8" value="WordPress"/> WordPress
              </label>
              <label>
                <input type="radio" name="q8" value="Grafana"/> Grafana
              </label>
              <label>
                <input type="radio" name="q8" value="Notepad++"/> Notepad++
              </label>
              <label>
                <input type="radio" name="q8" value="Photoshop"/> Photoshop
              </label>
            </div>
            <button class="next-btn" onclick="nextStep(4)">Siguiente</button>
          </section>

          <!-- Paso 5 -->
          <section class="question-section" id="step-5" style="display: none">
            <div class="question">
              <p><strong> 9.	¿Cuál es el propósito de la normalización?</strong></p>
              <label>
                <input type="radio" name="q9" value="Reducir la redundancia de datos"/> Reducir la redundancia de datos
              </label>
              <label>
                <input type="radio" name="q9" value="Crear claves foráneas"/> Crear claves foráneas
              </label>
              <label>
                <input type="radio" name="q9" value="Eliminar índices" /> Eliminar índices
              </label>
              <label>
                <input type="radio" name="q9" value="Comprimir las tablas" /> Comprimir las tablas
              </label>
            </div>
            <div class="question">
              <p><strong> 10.	¿Qué tipo de base de datos usarías para almacenar documentos en formato JSON?</strong></p>
              <label><input type="radio" name="q10" value="PostgreSQL" /> PostgreSQL</label>
              <label><input type="radio" name="q10" value="Oracle" /> Oracle</label>
              <label><input type="radio" name="q10" value="MongoDB"/> MongoDB</label>
              <label><input type="radio" name="q10" value="MariaDB" /> MariaDB</label>
            </div>
            <button class="submit-btn" onclick="finalizarExamen()">
              Enviar evaluación
            </button>
          </section>

          <!-- Mensaje final -->
          <section class="question-section" id="final-msg" style="display: none">
            <h2>¡Gracias por completar tu examen!</h2>
            <p>
              Está al pendiente de tu puntuación y si pasaste a la siguiente etapa.
            </p>
          </section>
        </main>
      </div>
    </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import {
    getDatabase,
    ref,
    update,
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC_I3bIIk0nfGvuDSK0nZ_JcI7ywTP_Rd8",
    authDomain: "talentchek-t.firebaseapp.com",
    projectId: "talentchek-t",
    databaseURL: "https://talentchek-t-default-rtdb.firebaseio.com",
    storageBucket: "talentchek-t.appspot.com",
    messagingSenderId: "546382065526",
    appId: "1:546382065526:web:249deb0e90ff9b358bd457",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let streamGlobal = null;
  let currentUser = null;
  let inicioExamTimestamp = null;

  const userIcon = document.getElementById("userIcon");
  const dropdownMenu = document.getElementById("dropdownMenu");

  userIcon.addEventListener("click", () => {
    dropdownMenu.style.display =
      dropdownMenu.style.display === "block" ? "none" : "block";
  });

  document.addEventListener("click", (e) => {
    if (!userIcon.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.style.display = "none";
    }
  });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
    } else {
      window.location.href = "inicioSesion.html";
    }
  });

  function activarCamara() {
    const video = document.getElementById("video");
    const startBtn = document.getElementById("startBtn");

    navigator.mediaDevices
      .getUserMedia({ video: true })
      .then((stream) => {
        streamGlobal = stream;
        video.srcObject = stream;
        startBtn.disabled = false;
        console.log("Cámara activada y botón habilitado");
      })
      .catch((err) => {
        console.error("Error al acceder a la cámara:", err);
        alert("⚠️ Debes permitir acceso a la cámara para continuar.");
        startBtn.disabled = true;
      });
  }
  window.activarCamara = activarCamara;

  function startEvaluation() {
    document.getElementById("intro").style.display = "none";
    document.getElementById("step-1").style.display = "block";

    if (!inicioExamTimestamp && currentUser) {
      inicioExamTimestamp = new Date().toISOString();

      const examenesAccedidosRef = ref(db, `candidatos/${currentUser.uid}/examenesAccedidos`);
      update(examenesAccedidosRef, {
        inicioexamCono: inicioExamTimestamp,
      }).catch((e) => {
        console.error("Error guardando inicio del examen:", e);
      });
    }
  }
  window.startEvaluation = startEvaluation;

  function nextStep(num) {
    const currentStep = document.getElementById(`step-${num}`);
    const inputs = currentStep.querySelectorAll('input[type="radio"]');
    const totalQuestions = new Set(Array.from(inputs).map((i) => i.name)).size;
    const checkedCount = new Set(
      Array.from(inputs).filter((i) => i.checked).map((i) => i.name)
    ).size;

    if (checkedCount < totalQuestions) {
      alert("Por favor responde todas las preguntas antes de continuar.");
      return;
    }

    currentStep.style.display = "none";
    const nextStepEl = document.getElementById(`step-${num + 1}`);
    if (nextStepEl) nextStepEl.style.display = "block";
  }
  window.nextStep = nextStep;

  async function finalizarExamen() {
    const currentStep = document.getElementById("step-5");
    const inputs = currentStep.querySelectorAll('input[type="radio"]');
    const totalQuestions = new Set(Array.from(inputs).map((i) => i.name)).size;
    const checkedCount = new Set(
      Array.from(inputs).filter((i) => i.checked).map((i) => i.name)
    ).size;

    if (checkedCount < totalQuestions) {
      alert("Por favor responde todas las preguntas antes de enviar.");
      return;
    }

    if (!currentUser) {
      alert("Usuario no autenticado. No se puede guardar el examen.");
      return;
    }

    const respuestas = {};
    for (let i = 1; i <= 5; i++) {
      const stepSection = document.getElementById(`step-${i}`);
      const checkedInputs = stepSection.querySelectorAll(
        'input[type="radio"]:checked'
      );
      checkedInputs.forEach((input) => {
        respuestas[input.name] = input.value;
      });
    }

    function obtenerRespuestas() {
  const respuestas = {};
  for (let i = 1; i <= 10; i++) {
    const nombre = `q${i}`;
    const seleccionada = document.querySelector(`input[name="${nombre}"]:checked`);
    respuestas[nombre] = seleccionada ? seleccionada.value : null;
  }
  return respuestas;
}

    const respuestasCorrectas = {
      q1: "MySQL",
      q2: "SELECT",
      q3: "NoSQL",
      q4: "Reducir el tiempo de respuesta de las consultas",
      q5: "Atomicidad, Consistencia, Aislamiento, Durabilidad",
      q6: "Automatizar los respaldos diarios",
      q7: "SQL",
      q8: "Grafana",
      q9: "Reducir la redundancia de datos",
      q10: "MongoDB",
    };

    let aciertos = 0;
    for (const [key, valor] of Object.entries(respuestasCorrectas)) {
      if (respuestas[key] === valor) {
        aciertos++;
      }
    }

    try {
  const candidatoRef = ref(db, `candidatos/${currentUser.uid}`);
  const procesoRef = ref(db, `candidatos/${currentUser.uid}/proceso`);
  const examenesAccedidosRef = ref(db, `candidatos/${currentUser.uid}/examenesAccedidos`);
  const finExamTimestamp = new Date().toISOString();

  await update(candidatoRef, {
    aciertosexamcono: aciertos,
    respuestasexamcono: respuestas   
  });

  await update(procesoRef, {
    examen_conocimiento: "completado"
  });

  await update(examenesAccedidosRef, {
    finexamCono: finExamTimestamp
  });

  for (let i = 1; i <= 5; i++) {
    document.getElementById(`step-${i}`).style.display = "none";
  }
  document.getElementById("intro").style.display = "none";
  document.getElementById("final-msg").style.display = "block";

  if (streamGlobal) {
    streamGlobal.getTracks().forEach((t) => t.stop());
    streamGlobal = null;
  }
  document.getElementById("video-container").style.display = "none";
} catch (e) {
  alert("Error guardando resultados: " + e.message);
}

  }
  window.finalizarExamen = finalizarExamen;

  document.getElementById("logoutBtn").addEventListener("click", () => {
    if (confirm("¿Estás seguro que deseas cerrar sesión?")) {
      if (streamGlobal) {
        streamGlobal.getTracks().forEach((t) => t.stop());
        streamGlobal = null;
      }
      signOut(auth)
        .then(() => {
          window.location.href = "inicioSesion.html";
        })
        .catch((e) => alert("Error al cerrar sesión: " + e.message));
    }
  });
</script>

  </body>
</html>
