<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="lib/img/logoredondo.png">
  <title>Examen Psicom</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="lib/css/examenPsico.css" />
</head>
<body>
  <div class="main-layout">
    <!-- Header -->
    <header class="main-header">
      <a href="perfilCandidato.html" class="header-left">
        <img src="lib/img/logo.jpg" alt="Logo" />
        <span class="title">TalentCheck</span>
      </a>
       <div class="user-menu">
          <span id="userIcon" class="user-icon"></span>
          <div id="dropdownMenu" class="dropdown">
            <a href="#" id="logoutBtn">Cerrar sesi贸n</a>
            <a href="perfil.html">Ver Perfil</a>
          </div>
        </div>
    </header>

    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <nav class="nav">
          <a href="perfilCandidato.html"><button class="nav-btn"><i class="fas fa-home"></i></button></a>
          <a href="modificar.html"><button class="nav-btn"><i class="fas fa-edit"></i></button></a>
          <a href="proceso.html"><button class="nav-btn"><i class="fas fa-spinner fa-spin"></i></button></a>
          <a href="acceso.html"><button class="nav-btn"><i class="fas fa-clipboard-list"></i></button></a>
          <a href="accesodos.html"><button class="nav-btn"><i class="fas fa-brain"></i></button></a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="exam-content">
        <!-- Video siempre visible -->
        <div id="video-container">
          <video id="video" width="100" height="80" autoplay muted></video>
        </div>

        <!-- Intro -->
        <section class="intro-section" id="intro">
          <div class="robot-box">
            <img src="data:image/png;base64,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" class="robot-img" alt="Robot">
          </div>
          <h2>Examen Psicom茅trico</h2>
          <button class="camera-btn" id="camara" onclick="activarCamara()"><i class="fas fa-video"></i> Encender c谩mara</button>
          <button class="start-btn" id="startBtn" onclick="startEvaluation()" disabled>Iniciar evaluaci贸n</button>
          <p class="camera-warning">* Debes permitir el acceso a la c谩mara para comenzar el examen.</p>
        </section>

        <!-- Paso 1 -->
        <section class="question-section" id="step-1" style="display:none;">
          <div class="question">
            <p><strong>1. 驴Cu谩l de estas opciones describe mejor qu茅 te motiva a trabajar?</strong></p>
            <label><input type="radio" name="p1" value="Dinero"> Dinero</label><br>
            <label><input type="radio" name="p1" value="Reconocimiento"> Reconocimiento</label><br>
            <label><input type="radio" name="p1" value="Pasi贸n por lo que hago"> Pasi贸n por lo que hago</label><br>
          </div>
          <div class="question">
            <p><strong>2. 驴C贸mo reaccionas ante una cr铆tica?</strong></p>
            <label><input type="radio" name="p2" value="Escucho y reflexiono"> Escucho y reflexiono</label><br>
            <label><input type="radio" name="p2" value="Me molesto"> Me molesto</label><br>
            <label><input type="radio" name="p2" value="Ignoro la cr铆tica"> Ignoro la cr铆tica</label><br>
            </div>
          <button class="next-btn" onclick="nextStep(1)">Siguiente</button>
        </section>

        <!-- Paso 2 -->
        <section class="question-section" id="step-2" style="display:none;">
          <div class="question">
            <p><strong>3. Cuando tienes una tarea dif铆cil, 驴qu茅 haces?</strong></p>
            <label><input type="radio" name="p3" value="Pido ayuda"> Pido ayuda</label><br>
            <label><input type="radio" name="p3" value="Lo intento solo"> Lo intento solo</label><br>
            <label><input type="radio" name="p3" value="Lo dejo para despu茅s"> Lo dejo para despu茅s</label><br>
          </div>
          <div class="question">
            <p><strong>4. 驴C贸mo manejas las cr铆ticas constructivas?</strong></p>
            <label><input type="radio" name="p4" value="Las acepto y mejoro"> Las acepto y mejoro</label><br>
            <label><input type="radio" name="p4" value="Las ignoro"> Las ignoro</label><br>
            <label><input type="radio" name="p4" value="Me afectan mucho"> Me afectan mucho</label><br>
          </div>
          <div class="question">
            <p><strong>5. 驴C贸mo te organizas para cumplir tus metas?</strong></p>
            <label><input type="radio" name="p5" value="Planifico con anticipaci贸n"> Planifico con anticipaci贸n</label><br>
            <label><input type="radio" name="p5" value="Voy improvisando"> Voy improvisando</label><br>
            <label><input type="radio" name="p5" value="No suelo planificar"> No suelo planificar</label><br>
          </div>
          <button class="next-btn" onclick="nextStep(2)">Siguiente</button>
        </section>

        <!-- Paso 3 -->
        <section class="question-section" id="step-3" style="display:none;">
          <div class="question">
            <p><strong>6. 驴Qu茅 haces cuando te sientes frustrado?</strong></p>
            <label><input type="radio" name="p6" value="Busco soluciones"> Busco soluciones</label><br>
            <label><input type="radio" name="p6" value="Me doy un tiempo para calmarme"> Me doy un tiempo para calmarme</label><br>
            <label><input type="radio" name="p6" value="Me rindo"> Me rindo</label><br>
          </div>
          <div class="question">
            <p><strong>7. 驴C贸mo manejas los cambios inesperados?</strong></p>
            <label><input type="radio" name="p7" value="Me adapto r谩pidamente"> Me adapto r谩pidamente</label><br>
            <label><input type="radio" name="p7" value="Me estreso"> Me estreso</label><br>
            <label><input type="radio" name="p7" value="Busco ayuda"> Busco ayuda</label><br>
          </div>
          <button class="submit-btn" onclick="finalizarExamen()">Enviar evaluaci贸n</button>
        </section>

        <!-- Mensaje final -->
        <section class="question-section" id="final-msg" style="display:none;">
          <h2>隆Gracias por completar el examen psicom茅trico!</h2>
          <p>Tu evaluaci贸n ha sido guardada correctamente.</p>
        </section>
      </main>
    </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import {
    getDatabase,
    ref,
    update,
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC_I3bIIk0nfGvuDSK0nZ_JcI7ywTP_Rd8",
    authDomain: "talentchek-t.firebaseapp.com",
    projectId: "talentchek-t",
    databaseURL: "https://talentchek-t-default-rtdb.firebaseio.com",
    storageBucket: "talentchek-t.appspot.com",
    messagingSenderId: "546382065526",
    appId: "1:546382065526:web:249deb0e90ff9b358bd457",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let streamGlobal = null;
  let currentUser = null;
  let inicioExamTimestamp = null;

  const userIcon = document.getElementById("userIcon");
  const dropdownMenu = document.getElementById("dropdownMenu");

  userIcon.addEventListener("click", () => {
    dropdownMenu.style.display =
      dropdownMenu.style.display === "block" ? "none" : "block";
  });

  document.addEventListener("click", (e) => {
    if (!userIcon.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.style.display = "none";
    }
  });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
    } else {
      window.location.href = "inicioSesion.html";
    }
  });

  function activarCamara() {
    const video = document.getElementById("video");
    const startBtn = document.getElementById("startBtn");

    navigator.mediaDevices
      .getUserMedia({ video: true })
      .then((stream) => {
        streamGlobal = stream;
        video.srcObject = stream;
        startBtn.disabled = false;
        console.log("C谩mara activada y bot贸n habilitado");
      })
      .catch((err) => {
        console.error("Error al acceder a la c谩mara:", err);
        alert("锔 Debes permitir acceso a la c谩mara para continuar.");
        startBtn.disabled = true;
      });
  }
  window.activarCamara = activarCamara;

  function startEvaluation() {
    document.getElementById("intro").style.display = "none";
    document.getElementById("step-1").style.display = "block";

    if (!inicioExamTimestamp && currentUser) {
      inicioExamTimestamp = new Date().toISOString();

      const examenesAccedidosRef = ref(db, `candidatos/${currentUser.uid}/examenesAccedidos`);
      update(examenesAccedidosRef, {
        inicioexamPsico: inicioExamTimestamp,
      }).catch((e) => {
        console.error("Error guardando inicio del examen:", e);
      });
    }
  }
  window.startEvaluation = startEvaluation;

  function nextStep(num) {
    const currentStep = document.getElementById(`step-${num}`);
    const inputs = currentStep.querySelectorAll('input[type="radio"]');
    const totalQuestions = new Set(Array.from(inputs).map((i) => i.name)).size;
    const checkedCount = new Set(
      Array.from(inputs).filter((i) => i.checked).map((i) => i.name)
    ).size;

    if (checkedCount < totalQuestions) {
      alert("Por favor responde todas las preguntas antes de continuar.");
      return;
    }

    currentStep.style.display = "none";
    const nextStepEl = document.getElementById(`step-${num + 1}`);
    if (nextStepEl) nextStepEl.style.display = "block";
  }
  window.nextStep = nextStep;

  async function finalizarExamen() {
    const currentStep = document.getElementById("step-3");
    const inputs = currentStep.querySelectorAll('input[type="radio"]');
    const totalQuestions = new Set(Array.from(inputs).map((i) => i.name)).size;
    const checkedCount = new Set(
      Array.from(inputs).filter((i) => i.checked).map((i) => i.name)
    ).size;

    if (checkedCount < totalQuestions) {
      alert("Por favor responde todas las preguntas antes de enviar.");
      return;
    }

    if (!currentUser) {
      alert("Usuario no autenticado. No se puede guardar el examen.");
      return;
    }

    const respuestas = {};
    for (let i = 1; i <= 3; i++) {
      const stepSection = document.getElementById(`step-${i}`);
      const checkedInputs = stepSection.querySelectorAll(
        'input[type="radio"]:checked'
      );
      checkedInputs.forEach((input) => {
        respuestas[input.name] = input.value;
      });
    }

    function obtenerRespuestas() {
  const respuestas = {};
  for (let i = 1; i <= 10; i++) {
    const nombre = `q${i}`;
    const seleccionada = document.querySelector(`input[name="${nombre}"]:checked`);
    respuestas[nombre] = seleccionada ? seleccionada.value : null;
  }
  return respuestas;
}

    const respuestasCorrectas = {
      p1: "Pasi贸n por lo que hago",
      p2: "Escucho y reflexiono",
      p3: "Pido ayuda",
      p4: "Las acepto y mejoro",
      p5: "Planifico con anticipaci贸n",
      p6: "Busco soluciones",
      p7: "Me adapto r谩pidamente",
    };

    let aciertos = 0;
    for (const [key, valor] of Object.entries(respuestasCorrectas)) {
      if (respuestas[key] === valor) {
        aciertos++;
      }
    }

    try {
      const candidatoRef = ref(db, `candidatos/${currentUser.uid}`);
      const procesoRef = ref(db, `candidatos/${currentUser.uid}/proceso`);
      const examenesAccedidosRef = ref(db, `candidatos/${currentUser.uid}/examenesAccedidos`);
      const finExamTimestamp = new Date().toISOString();

      await update(candidatoRef, {
        aciertosexampsico: aciertos,
        respuestasexampsico: respuestas
      });

      await update(procesoRef, {
        examen_psicometrico: "completado"
      });

      await update(examenesAccedidosRef, {
        finexamPsico: finExamTimestamp
      });

      for (let i = 1; i <= 3; i++) {
        document.getElementById(`step-${i}`).style.display = "none";
      }
      document.getElementById("intro").style.display = "none";
      document.getElementById("final-msg").style.display = "block";

      if (streamGlobal) {
        streamGlobal.getTracks().forEach((t) => t.stop());
        streamGlobal = null;
      }
      document.getElementById("video-container").style.display = "none";
    } catch (e) {
      alert("Error guardando resultados: " + e.message);
    }
  }
  window.finalizarExamen = finalizarExamen;

  document.getElementById("logoutBtn").addEventListener("click", () => {
    if (confirm("驴Est谩s seguro que deseas cerrar sesi贸n?")) {
      if (streamGlobal) {
        streamGlobal.getTracks().forEach((t) => t.stop());
        streamGlobal = null;
      }
      signOut(auth)
        .then(() => {
          window.location.href = "inicioSesion.html";
        })
        .catch((e) => alert("Error al cerrar sesi贸n: " + e.message));
    }
  });
</script>
  </div>
</body>
</html>
