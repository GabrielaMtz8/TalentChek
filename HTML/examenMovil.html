<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="lib/img/logoredondo.png">
    <title>Examen de Conocimiento</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="lib/css/examenCono.css" />
  </head>
  <body>
    <div class="main-layout">
      <header class="main-header">
        <a href="perfilCandidato.html" class="header-left">
          <img src="lib/img/logo.jpg" alt="Logo" />
          <span class="title">TalentCheck</span>
        </a>
        <div class="user-menu">
          <span id="userIcon" class="user-icon">👤</span>
          <div id="dropdownMenu" class="dropdown">
            <a href="#" id="logoutBtn">Cerrar sesión</a>
            <a href="perfil.html">Ver Perfil</a>
          </div>
        </div>
      </header>

      <div class="container">
        <aside class="sidebar">
          <nav class="nav">
            <a href="perfilCandidato.html"
              ><button class="nav-btn"><i class="fas fa-home"></i></button
            ></a>
            <a href="modificar.html"
              ><button class="nav-btn"><i class="fas fa-edit"></i></button
            ></a>
            <a href="proceso.html"
              ><button class="nav-btn">
                <i class="fas fa-spinner fa-spin"></i></button
            ></a>
            <a href="acceso.html"
              ><button class="nav-btn">
                <i class="fas fa-clipboard-list"></i></button
            ></a>
            <a href="accesodos.html"
              ><button class="nav-btn"><i class="fas fa-brain"></i></button
            ></a>
          </nav>
        </aside>

        <main class="exam-content">
          <!-- Video de cámara -->
          <div id="video-container">
            <video id="video" width="100" height="80" autoplay muted></video>
          </div>

          <!-- Paso: Introducción -->
          <section class="intro-section" id="intro">
            <div class="robot-box">
              <img
                src="https://cdn-icons-png.flaticon.com/512/4712/4712107.png"
                class="robot-img"
                alt="Robot"
              />
            </div>
            <h2>Evaluación de Conocimiento</h2>
            <button class="camera-btn" id="camara" onclick="activarCamara()">
              <i class="fas fa-video"></i> Encender cámara
            </button>
            <button class="start-btn" id="startBtn" onclick="startEvaluation()" disabled>
              Iniciar evaluación
            </button>
            <p class="camera-warning">
              * Debes permitir el acceso a la cámara para comenzar el examen.
            </p>
          </section>

          <!-- Paso 1 -->
          <section class="question-section" id="step-1" style="display: none">
            <div class="question">
              <p>
                <strong> 1.	¿Cuál de los siguientes lenguajes se utiliza con Flutter?</strong>
              </p>
              <label
                ><input type="radio" name="q1" value="Swift" /> Swift</label
              >
              <label
                ><input type="radio" name="q1" value="Kotlin" /> Kotlin</label
              >
              <label
                ><input type="radio" name="q1" value="Dart" /> Dart</label
              >
              <label
                ><input type="radio" name="q1" value="JavaScript" /> JavaScript</label
              >
            </div>
            <div class="question">
              <p>
                <strong> 2. ¿Qué plataforma permite compilar una app móvil para Android e iOS desde un solo código base?</strong>
              </p>
              <label><input type="radio" name="q2" value="Xamarin" /> Xamarin</label>
              <label><input type="radio" name="q2" value="React Native" /> React Native</label>
              <label><input type="radio" name="q2" value="Cordova" /> Cordova</label>
              <label><input type="radio" name="q2" value="Todas las anteriores" /> Todas las anteriores</label>
            </div>
            <button class="next-btn" onclick="nextStep(1)">Siguiente</button>
          </section>

          <!-- Paso 2 -->
          <section class="question-section" id="step-2" style="display: none">
            <div class="question">
              <p><strong> 3.	¿Cuál es la función del Navigator en Flutter?</strong></p>
              <label><input type="radio" name="q3" value="Acceder a la base de datos" /> Acceder a la base de datos</label>
              <label><input type="radio" name="q3" value="Manejar la navegación entre pantallas" /> Manejar la navegación entre pantallas</label>
              <label><input type="radio" name="q3" value="Dibujar widgets" /> Dibujar widgets</label>
              <label><input type="radio" name="q3" value="Compilar la app" /> Compilar la app</label>
            </div>
            <div class="question">
              <p><strong> 4.	¿Qué archivo se modifica en Android para declarar los permisos requeridos?</strong></p>
              <label><input type="radio" name="q4" value="build.gradle" /> build.gradle</label>
              <label><input type="radio" name="q4" value="AndroidManifest.xml" /> AndroidManifest.xml</label>
              <label><input type="radio" name="q4" value="pubspec.yaml" /> pubspec.yaml</label>
              <label><input type="radio" name="q4" value="MainActivity.java" /> MainActivity.java</label>
            </div>
            <button class="next-btn" onclick="nextStep(2)">Siguiente</button>
          </section>

          <!-- Paso 3 -->
          <section class="question-section" id="step-3" style="display: none">
            <div class="question">
              <p><strong>5.	¿Qué es el "hot reload" en Flutter?</strong></p>
              <label>
                <input type="radio" name="q5" value="Reinicia la app desde cero"/> Reinicia la app desde cero
              </label>
              <label>
                <input type="radio" name="q5"value="Borra la caché del dispositivo"/> Borra la caché del dispositivo
              </label>
              <label>
                <input type="radio" name="q5" value="Aplica cambios al código sin reiniciar completamente la app"/> Aplica cambios al código sin reiniciar completamente la app
              </label>
              <label>
                <input type="radio" name="q5" value="Elimina los errores automáticamente" /> Elimina los errores automáticamente
              </label>
            </div>
            <div class="question">
              <p><strong> 6.	¿Qué permite el uso de Firebase en una app móvil?</strong></p>
              <label>
                <input type="radio" name="q6" value="Crear gráficos 3D"/> Crear gráficos 3D
              </label>
              <label>
                <input type="radio" name="q6" value="Hacer llamadas por Bluetooth"/> Hacer llamadas por Bluetooth
              </label>
              <label>
                <input type="radio" name="q6" value="Autenticación, base de datos en tiempo real y notificaciones"/> Autenticación, base de datos en tiempo real y notificaciones
              </label>
              <label>
                <input type="radio" name="q6" value="Crear botones animados"/>  Crear botones animados
              </label>
            </div>
            <button class="next-btn" onclick="nextStep(3)">Siguiente</button>
          </section>

          <!-- Paso 4 -->
          <section class="question-section" id="step-4" style="display: none">
            <div class="question">
              <p><strong> 7.	¿Qué significa UI en desarrollo móvil?</strong></p>
              <label><input type="radio" name="q7" value="Unidad Informática" /> Unidad Informática</label>
              <label><input type="radio" name="q7" value="User Interface" /> User Interface</label>
              <label><input type="radio" name="q7" value="Uso Interno" /> Uso Interno</label>
              <label><input type="radio" name="q7" value="Utilidad Interactiva" /> Utilidad Interactiva</label>
            </div>
            <div class="question">
              <p><strong> 8.	¿Qué es un widget en Flutter?</strong></p>
              <label>
                <input type="radio" name="q8" value="Un script externo"/> Un script externo
              </label>
              <label>
                <input type="radio" name="q8" value="Un componente visual reutilizable"/> Un componente visual reutilizable
              </label>
              <label>
                <input type="radio" name="q8" value="Un archivo de configuración"/> Un archivo de configuración
              </label>
              <label>
                <input type="radio" name="q8" value="Un plugin de red"/> Un plugin de red
              </label>
            </div>
            <button class="next-btn" onclick="nextStep(4)">Siguiente</button>
          </section>

          <!-- Paso 5 -->
          <section class="question-section" id="step-5" style="display: none">
            <div class="question">
              <p><strong> 9.	¿Qué tecnología se usa para enviar notificaciones push?</strong></p>
              <label>
                <input type="radio" name="q9" value="Bluetooth"/> Bluetooth
              </label>
              <label>
                <input type="radio" name="q9" value="SMS"/> SMS
              </label>
              <label>
                <input type="radio" name="q9" value="Firebase Cloud Messaging (FCM)" /> Firebase Cloud Messaging (FCM)
              </label>
              <label>
                <input type="radio" name="q9" value="JSON" /> JSON
              </label>
            </div>
            <div class="question">
              <p><strong> 10.	¿Cuál de las siguientes es una ventaja del desarrollo multiplataforma?</strong></p>
              <label><input type="radio" name="q10" value="Mayor consumo de recursos" /> Mayor consumo de recursos</label>
              <label><input type="radio" name="q10" value="Menor rendimiento que nativo" /> Menor rendimiento que nativo</label>
              <label><input type="radio" name="q10" value="Reutilización del código para múltiples plataformas"/> Reutilización del código para múltiples plataformas</label>
              <label><input type="radio" name="q10" value="Necesidad de escribir el código dos veces" /> Necesidad de escribir el código dos veces</label>
            </div>
            <button class="submit-btn" onclick="finalizarExamen()">
              Enviar evaluación
            </button>
          </section>

          <!-- Mensaje final -->
          <section class="question-section" id="final-msg" style="display: none">
            <h2>¡Gracias por completar tu examen!</h2>
            <p>
              Está al pendiente de tu puntuación y si pasaste a la siguiente etapa.
            </p>
          </section>
        </main>
      </div>
    </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import {
    getDatabase,
    ref,
    update,
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC_I3bIIk0nfGvuDSK0nZ_JcI7ywTP_Rd8",
    authDomain: "talentchek-t.firebaseapp.com",
    projectId: "talentchek-t",
    databaseURL: "https://talentchek-t-default-rtdb.firebaseio.com",
    storageBucket: "talentchek-t.appspot.com",
    messagingSenderId: "546382065526",
    appId: "1:546382065526:web:249deb0e90ff9b358bd457",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let streamGlobal = null;
  let currentUser = null;
  let inicioExamTimestamp = null;

  const userIcon = document.getElementById("userIcon");
  const dropdownMenu = document.getElementById("dropdownMenu");

  userIcon.addEventListener("click", () => {
    dropdownMenu.style.display =
      dropdownMenu.style.display === "block" ? "none" : "block";
  });

  document.addEventListener("click", (e) => {
    if (!userIcon.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.style.display = "none";
    }
  });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
    } else {
      window.location.href = "inicioSesion.html";
    }
  });

  function activarCamara() {
    const video = document.getElementById("video");
    const startBtn = document.getElementById("startBtn");

    navigator.mediaDevices
      .getUserMedia({ video: true })
      .then((stream) => {
        streamGlobal = stream;
        video.srcObject = stream;
        startBtn.disabled = false;
        console.log("Cámara activada y botón habilitado");
      })
      .catch((err) => {
        console.error("Error al acceder a la cámara:", err);
        alert("⚠️ Debes permitir acceso a la cámara para continuar.");
        startBtn.disabled = true;
      });
  }
  window.activarCamara = activarCamara;

  function startEvaluation() {
    document.getElementById("intro").style.display = "none";
    document.getElementById("step-1").style.display = "block";

    if (!inicioExamTimestamp && currentUser) {
      inicioExamTimestamp = new Date().toISOString();

      const examenesAccedidosRef = ref(db, `candidatos/${currentUser.uid}/examenesAccedidos`);
      update(examenesAccedidosRef, {
        inicioexamCono: inicioExamTimestamp,
      }).catch((e) => {
        console.error("Error guardando inicio del examen:", e);
      });
    }
  }
  window.startEvaluation = startEvaluation;

  function nextStep(num) {
    const currentStep = document.getElementById(`step-${num}`);
    const inputs = currentStep.querySelectorAll('input[type="radio"]');
    const totalQuestions = new Set(Array.from(inputs).map((i) => i.name)).size;
    const checkedCount = new Set(
      Array.from(inputs).filter((i) => i.checked).map((i) => i.name)
    ).size;

    if (checkedCount < totalQuestions) {
      alert("Por favor responde todas las preguntas antes de continuar.");
      return;
    }

    currentStep.style.display = "none";
    const nextStepEl = document.getElementById(`step-${num + 1}`);
    if (nextStepEl) nextStepEl.style.display = "block";
  }
  window.nextStep = nextStep;

  async function finalizarExamen() {
    const currentStep = document.getElementById("step-5");
    const inputs = currentStep.querySelectorAll('input[type="radio"]');
    const totalQuestions = new Set(Array.from(inputs).map((i) => i.name)).size;
    const checkedCount = new Set(
      Array.from(inputs).filter((i) => i.checked).map((i) => i.name)
    ).size;

    if (checkedCount < totalQuestions) {
      alert("Por favor responde todas las preguntas antes de enviar.");
      return;
    }

    if (!currentUser) {
      alert("Usuario no autenticado. No se puede guardar el examen.");
      return;
    }

    const respuestas = {};
    for (let i = 1; i <= 5; i++) {
      const stepSection = document.getElementById(`step-${i}`);
      const checkedInputs = stepSection.querySelectorAll(
        'input[type="radio"]:checked'
      );
      checkedInputs.forEach((input) => {
        respuestas[input.name] = input.value;
      });
    }

    function obtenerRespuestas() {
  const respuestas = {};
  for (let i = 1; i <= 10; i++) {
    const nombre = `q${i}`;
    const seleccionada = document.querySelector(`input[name="${nombre}"]:checked`);
    respuestas[nombre] = seleccionada ? seleccionada.value : null;
  }
  return respuestas;
}

    const respuestasCorrectas = {
      q1: "Dart",
      q2: "Todas las anteriores",
      q3: "Manejar la navegación entre pantallas",
      q4: "AndroidManifest.xml",
      q5: "Aplica cambios al código sin reiniciar completamente la app",
      q6: "Autenticación, base de datos en tiempo real y notificaciones",
      q7: "User Interface",
      q8: "Un componente visual reutilizable",
      q9: "Firebase Cloud Messaging (FCM)",
      q10: "Reutilización del código para múltiples plataformas",
    };

    let aciertos = 0;
    for (const [key, valor] of Object.entries(respuestasCorrectas)) {
      if (respuestas[key] === valor) {
        aciertos++;
      }
    }

    try {
  const candidatoRef = ref(db, `candidatos/${currentUser.uid}`);
  const procesoRef = ref(db, `candidatos/${currentUser.uid}/proceso`);
  const examenesAccedidosRef = ref(db, `candidatos/${currentUser.uid}/examenesAccedidos`);
  const finExamTimestamp = new Date().toISOString();

  await update(candidatoRef, {
    aciertosexamcono: aciertos,
    respuestasexamcono: respuestas   
  });

  await update(procesoRef, {
    examen_conocimiento: "completado"
  });

  await update(examenesAccedidosRef, {
    finexamCono: finExamTimestamp
  });

  for (let i = 1; i <= 5; i++) {
    document.getElementById(`step-${i}`).style.display = "none";
  }
  document.getElementById("intro").style.display = "none";
  document.getElementById("final-msg").style.display = "block";

  if (streamGlobal) {
    streamGlobal.getTracks().forEach((t) => t.stop());
    streamGlobal = null;
  }
  document.getElementById("video-container").style.display = "none";
} catch (e) {
  alert("Error guardando resultados: " + e.message);
}

  }
  window.finalizarExamen = finalizarExamen;

  document.getElementById("logoutBtn").addEventListener("click", () => {
    if (confirm("¿Estás seguro que deseas cerrar sesión?")) {
      if (streamGlobal) {
        streamGlobal.getTracks().forEach((t) => t.stop());
        streamGlobal = null;
      }
      signOut(auth)
        .then(() => {
          window.location.href = "inicioSesion.html";
        })
        .catch((e) => alert("Error al cerrar sesión: " + e.message));
    }
  });
</script>

  </body>
</html>
